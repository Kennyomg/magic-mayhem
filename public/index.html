<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Mayhem</title>
  <script src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1" defer></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script type="module" crossorigin>(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(t){if(t.ep)return;t.ep=!0;const n=o(t);fetch(t.href,n)}})();const T=40,R=20;let se,ee,M,H,J="onorientationchange"in window&&"screen"in window,me=J?"orientationchange":"resize";var fe;let ae=((fe=screen==null?void 0:screen.orientation)==null?void 0:fe.type)||"landscape-primary";var he;(he=screen==null?void 0:screen.orientation)!=null&&he.angle;const E=document.getElementById("game"),U=document.getElementById("pause"),Ee=document.getElementById("game-over");function ne(){if(se=(J?screen.height:window.innerHeight)-E.offsetTop,M=se-50,H=25/18*M,ee=Math.max(75,Math.min(100,(J?screen.width:window.innerWidth)-H-20)),H>window.innerWidth&&(H=window.innerWidth-20,M=18/25*H),E.style.width=A(H),E.style.height=A(M),U.style.top=A(M/2+E.offsetTop),Ee.style.top=A(M/2+E.offsetTop),E.children.length)for(const i of E.getElementsByClassName("cell"))i.style.width=A(H/T),i.style.height=A(M/R),i.style.fontSize=A(M/R)}ne();window.addEventListener(me,function(){J&&ae!==screen.orientation.type&&(ae=screen.orientation.type,screen.orientation.angle),ne()},!1);J&&window.addEventListener("resize",()=>ne(),!1);let C=3,v="",Z,a,O=!1,we=!1;class X{constructor(o,r=0){this.text=o,this.ignoreFrontWidth=r}static async fromFile(o,r=0){try{return new this(await fetch(o).then(t=>t.text()),r)}catch(t){throw console.error(t),new Error("Cannot load sprite from file")}}get lines(){return this.text.split(`
`).filter(Boolean)}get width(){return Math.max(...this.lines.map(o=>o.length))}get collisionWidth(){return this.width-this.ignoreFrontWidth}get height(){return this.lines.length}getCharAt(o,r,t){return o<0||o>this.width||r<0||r>this.height?(console.error(`Cannot get sprite char at x: ${o} and y: ${r}`),!1):t?this.lines[r][this.width-1-o]:this.lines[r][o]}}let x;const re=10,ie=8,G=10,Y="blue",K=4,le=ie-1,D="red";let Q;const ce=ie-1,$=R-1,oe=K,ue=$-1;let V;const ye=$-1,S={EMPTY:"Â ",WALL:"#",PLAYER:"@",PORTAL:"O",SUMMON:"S"},P={LIGHT:{type:"LIGHT",x:1,y:$-1,sprite:void 0,speed:2,health:2,attack:1,team:"",mana_cost:1},MEDIUM:{type:"MEDIUM",x:1,y:$-1,sprite:void 0,speed:1,health:3,attack:2,team:"",mana_cost:2},HEAVY:{type:"HEAVY",x:1,y:$-1,sprite:void 0,speed:1,health:5,attack:1,team:"",mana_cost:3}},ge=document.getElementById("summons");ge.innerHTML="type, manacost, health, attack, speed<br/>";ge.innerHTML+=Object.values(P).map(i=>`${i.type}, ${i.mana_cost}, ${i.health}, ${i.attack}, ${i.speed}`).join("<br/>");let I;window.location.hostname.includes("localhost")?I=new WebSocket(`ws://${window.location.hostname}:3000/ws`):I=new WebSocket(`wss://${window.location.hostname}/ws`);I.onopen=()=>{console.log("Connected to server"),v?I.send(JSON.stringify({type:"join_lobby",data:v})):te().then(i=>{v=i,I.send(JSON.stringify({type:"join_lobby",data:v}))})};I.onclose=()=>{console.log("Disconnected from server")};(async()=>{console.log("magic-mayhem.js loaded");const i=document.getElementById("game-speed"),o=document.getElementById("game-over");i.textContent=C.toString();let r=pe(E),t=!1,n=!1,s=0,c=!1,d=[],u="",f="",y=G,g=G;try{x=await X.fromFile("./wizard.txt"),Q=T-K-x.width,V=Q+x.width-1,P.LIGHT.sprite=await X.fromFile("./light.txt"),P.MEDIUM.sprite=await X.fromFile("./medium.txt"),P.HEAVY.sprite=await X.fromFile("./heavy.txt",3),console.log(P)}catch(p){console.error(p)}function j(p){E.innerHTML="",o.classList.add("hidden"),s=0,c=!1,d=[],y=G,g=G,u="",f="",r=pe(E),B(r,d),t=!1,n=!1,a&&confirm("Do you want to leave the game?")&&(O?(I.send(JSON.stringify({type:"delete_game",data:a})),O=!1):I.send(JSON.stringify({type:"leave_game",data:a})),a=null)}function F(p){t=!t,document.getElementById("pause").classList.toggle("hidden")}function z(p,L){function k(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!(t||n||we||a&&!O)&&(!u&&p==="player"&&(u=L.dataset.summon),!f&&p==="opponent")){if(a&&O)return;f=L.dataset.summon}}L.addEventListener("click",k),L.addEventListener("touchend",k)}let _=!1;function w(p){if(_)return _=!1;if(p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation(),n){j();return}F()}E.addEventListener("click",w),E.addEventListener("touchstart",()=>_=!1,{passive:!0}),E.addEventListener("touchmove",()=>_=!0,{passive:!0}),E.addEventListener("touchend",w),U.addEventListener("click",w),U.addEventListener("touchstart",()=>_=!1,{passive:!0}),U.addEventListener("touchmove",()=>_=!0,{passive:!0}),U.addEventListener("touchend",w),o.addEventListener("click",w),o.addEventListener("touchstart",()=>_=!1,{passive:!0}),o.addEventListener("touchmove",()=>_=!0,{passive:!0}),o.addEventListener("touchend",w),playerButtons=document.getElementById("player-buttons"),playerButtons.width=ee;for(const p of playerButtons.getElementsByClassName("summon-button"))z("player",p);opponentButtons=document.getElementById("opponent-buttons"),opponentButtons.width=ee;for(const p of opponentButtons.getElementsByClassName("summon-button"))z("opponent",p);window.addEventListener("scroll",()=>{const p=window.scrollY>E.offsetTop+E.clientHeight-E.clientHeight/4*3;playerButtons.classList.toggle("hidden",p),opponentButtons.classList.toggle("hidden",p)}),I.onmessage=({data:p})=>{const L=JSON.parse(p),k=document.getElementById("games");switch(L.type){case"broadcast":{if(console.log("Broadcast",L),a)return;if(Array.isArray(L.data)){k.innerHTML="";let e=1;for(const h of L.data){if(console.log("game",h),h.opponentPeerId===v){a=h;break}if(h.hostPeerId===v&&h.opponentPeerId){if(O&&a)break;O=!0,a=h;break}if(h.hostPeerId===v){const m=document.createElement("button");m.textContent=`Waiting for opponent ${e}`,k.appendChild(m),e++;continue}const l=document.createElement("button");l.textContent=`Join game ${e}`,l.onclick=async()=>{console.log("Joining game",e);const m=v||await te();Z||(Z=new Peer(m,{host:"localhost",port:3e3,path:"/peerjs/myapp"})),console.log("peer",m,Z),I.send(JSON.stringify({type:"join_game",data:{hostPeerId:h.hostPeerId,opponentPeerId:m}}))},k.appendChild(l),e++}}break}case"game_updated":{console.log("Game updated"),a.data=L.data,B(r,a.data.summons,a.data.playerMana,a.data.opponentMana);break}case"game_deleted":{a=null;break}case"spawn":{f=L.data.summon;break}default:{console.log("Unknown message",L);break}}},window.addEventListener("keydown",async p=>{switch(p.key){case"j":v||(v=await te()),I.send(JSON.stringify({type:"create_game",data:v}));break;case" ":if(p.preventDefault(),n)break;F();break;case"r":case"R":j();break;case"z":if(t)break;u||(u="LIGHT");break;case"x":if(t)break;u||(u="MEDIUM");break;case"c":if(t)break;u||(u="HEAVY");break;case"/":if(t)break;if(a){O||I.send(JSON.stringify({type:"spawn",data:{summon:"LIGHT",hostPeerId:a.hostPeerId}}));break}f||(f="LIGHT");break;case".":if(t)break;if(a){O||I.send(JSON.stringify({type:"spawn",data:{summon:"MEDIUM",hostPeerId:a.hostPeerId}}));break}f||(f="MEDIUM");break;case",":if(t)break;if(a){O||I.send(JSON.stringify({type:"spawn",data:{summon:"HEAVY",hostPeerId:a.hostPeerId}}));break}f||(f="HEAVY");break;case"+":C<100&&(C+=1,i.textContent=C.toString(),W());break;case"-":C>1&&(C-=1,i.textContent=C.toString(),W());break}});let b=null;function W(){clearInterval(b),b=setInterval(()=>{var p,L,k;if(!(a&&!O)){if(a&&(a.hostPeerId===v&&I.send(JSON.stringify({type:"update_game",data:{...a,data:{summons:d,playerMana:y,opponentMana:g}}})),a.opponentPeerId===v&&(d=(p=a.data)!=null&&p.summons?a.data.summons:[],y=((L=a.data)==null?void 0:L.playerMana)>=0?a.data.playerMana:G,g=((k=a.data)==null?void 0:k.playerMana)>=0?a.data.opponentMana:G,d.length))){B(r,d,y,g);return}if(!t){(!a||O)&&(u&&!d.some(e=>{var h,l;return e.team==="player"&&q(oe,ue,(l=(h=P[u])==null?void 0:h.sprite)==null?void 0:l.collisionWidth,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(y>=P[u].mana_cost&&y>=y-P[u].mana_cost&&(y-=P[u].mana_cost,d.push(de("player",u))),u=""),f&&!d.some(e=>{var h,l;return e.team==="opponent"&&q(V-((l=(h=P[f])==null?void 0:h.sprite)==null?void 0:l.collisionWidth),ye,V,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(g>=P[f].mana_cost&&g>=g-P[f].mana_cost&&(g-=P[f].mana_cost,d.push(de("opponent",f))),f="")),B(r,d,y,g);for(const e of d){const h=e.x+e.speed*e.direction;if(!d.some(l=>l!==e&&q(h,e.y,e.sprite.collisionWidth,e.sprite.height,l.x,l.y,l.sprite.collisionWidth,l.sprite.height)))h>0&&h<T-e.sprite.collisionWidth?e.x=h:(e.x=h<=0?1:T-e.sprite.collisionWidth-1,e.direction*=-1),c=!0;else{const l=d.find(m=>m!==e&&q(h,e.y,e.sprite.collisionWidth,e.sprite.height,m.direction>0?m.x:m.x+m.sprite.ignoreFrontWidth,m.y,m.sprite.collisionWidth,m.sprite.height));if(e&&l&&(e!=null&&e.type)&&(l!=null&&l.type)&&e.type==="LIGHT"&&l.type==="HEAVY"&&(e.team===l.team||e.direction!==l.direction)||e.type==="HEAVY"&&l.type==="LIGHT"&&(e.team===l.team||e.direction!==l.direction)){e.x=h,c=!0;continue}e&&l&&e.attack>0&&e.team!==l.team&&e.health>0&&l.health>0&&(l.health-=e.attack,l.health<=0&&(d=d.filter(m=>m!==l)),c=!0)}}c?s=0:s++,s>10&&!(y||g)&&(t=!0,n=!0,o.innerHTML=`Draw!!\r
Press R or Tap here.`,o.classList.remove("hidden"),B(r,d,y,g)),c=!1,!d.some(e=>e.team==="player")&&!y&&(t=!0,n=!0,o.innerHTML=`<span style="color:${D};">${D.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,o.classList.remove("hidden"),B(r,d,y,g)),!d.some(e=>e.team==="opponent")&&!g&&(t=!0,n=!0,o.innerHTML=`<span style="color:${Y};">${Y.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,o.classList.remove("hidden"),B(r,d,y,g))}}},1e3/C)}W()})();function A(i){return`${i}px`}async function te(){return await fetch("http://localhost:3000/peerjs/myapp/peerjs/id").then(i=>i.body.getReader().read()).then(({value:i,done:o})=>new TextDecoder().decode(i))}function de(i,o){if(!(i==="player"||i==="opponent"))throw new Error("Invalid team");return{...P[o],x:i==="player"?oe:V-P[o].sprite.width+1,direction:i==="player"?1:-1,color:i==="player"?Y:D,team:i}}function pe(i){return new Array(R).fill(null).map((o,r)=>(r>0&&i.appendChild(document.createElement("br")),new Array(T).fill(null).map(()=>{const t=document.createElement("span");return t.classList.add("cell"),t.style.width=A(H/T),t.style.height=A(M/R),t.style.fontSize=A(M/R),t.textContent=S.EMPTY,i.appendChild(t),t})))}function N(i,o,r,t,n,s){return i>=r&&i<r+n&&o<=t&&o>t-s}function q(i,o,r,t,n,s,c,d){return N(i,o,n,s,c,d)||N(i+r-1,o,n,s,c,d)||N(i,o-t,n,s,c,d)||N(i+r-1,o-t,n,s,c,d)}function B(i,o,r,t){o.sort((n,s)=>n.type===s.type?0:n.type==="HEAVY"&&s.type!=="HEAVY"||n.type==="MEDIUM"&&s.type==="LIGHT"?-1:(n.type==="LIGHT"&&s.type!=="LIGHT",1));for(let n=0;n<R;n++)for(let s=0;s<T;s++){const c=i[n][s],d=s===0||s===T-1||n===0||n===R-1,u=s>0&&(s<re||s>T-1-re)&&s<T-1&&n===ie,f=N(s,n,K,le,x.width,x.height),y=N(s,n,Q,ce,x.width,x.height),g=s===oe&&n===ue,j=s===V&&n===ye,F=r&&(s===1||s<=r)&&n===1,z=t&&(s===T-2||s>=T-1-t)&&n===1,_=o.some(w=>N(s,n,w.x,w.y,w.sprite.width,w.sprite.height));switch(!0){case(d||u):c.classList.add("wall"),c.textContent!==S.WALL&&(c.textContent=S.WALL);break;case F:c.textContent="*",c.style.color=Y;break;case z:c.textContent="*",c.style.color=D;break;case(f||y):{let w;(w=x.getCharAt(s-(f?K:Q),n-(f?le:ce)+x.height-1,y))&&c.textContent!==w&&(c.textContent=w,c.style.color=f?Y:D,y&&c.classList.add("reversed"));break}case _:{o.filter(b=>N(s,n,b.x,b.y,b.sprite.width,b.sprite.height)).forEach(b=>{const W=b.direction===-1,p=b.sprite.getCharAt(s-b.x,n-b.y+b.sprite.height-1,W);c.classList.toggle("reversed",W),c.textContent=p,c.style.color=b.color});break}case(g||j):c.textContent!==S.PORTAL&&(c.textContent=S.PORTAL,c.style.color=g?Y:D);break;default:c.textContent!==S.EMPTY&&(c.textContent=S.EMPTY);break}}}
</script>
  <style rel="stylesheet" crossorigin>body{font-family:Courier New,Courier,monospace;display:flex;justify-content:center}br{display:block;height:0}#game{width:fit-content;margin:0 auto}.cell{display:block;float:left;font-size:25px;line-height:1;font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000}#game br{display:block;height:0;line-height:0;content:"";margin:0}.blue{color:#00f}.red{color:red}#pause{position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;-webkit-user-select:none;user-select:none}#game-over{text-align:center;position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;white-space:pre;-webkit-user-select:none;user-select:none}.summon-button{display:inline-block;aspect-ratio:1/1;font-size:min(100px,calc((100svh / 3) - 20px));font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000;border:2px solid white;border-radius:50%;cursor:pointer;max-width:100%;text-align:center;line-height:1}#player-buttons,#opponent-buttons{touch-action:none;display:flex;flex-direction:column;gap:10px;width:min(100px,calc((100svh / 3) - 20px))}#player-buttons>.summon-button:hover,#player-buttons>.summon-button:active{color:#00f;border-color:#00f}#opponent-buttons>.summon-button:hover,#opponent-buttons>.summon-button:active{color:red;border-color:red}.hidden{display:none!important}.reversed{transform:rotateY(180deg)}.show-on-root,.mobile{display:none}.top{position:fixed;top:0}.middle{position:fixed;top:50%;transform:translateY(-50%)}.left{position:fixed;left:10px}.right{position:fixed;right:10px}.bottom{position:fixed;bottom:0}.vertical{display:flex;flex-direction:column}#warning-message{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px}@media screen and (max-width: 425px){#game,.mobile-landscape{display:none}#warning-message{display:block}}@media screen and (min-width: 425px) and (max-width: 868px) and (orientation: landscape){.mobile{display:block}.vertical{display:flex}}@media screen and (min-width: 868px){.mobile{display:none}}
</style>
</head>

<body style="background-color: black; color: white;">
  <google-cast-launcher></google-cast-launcher>
  <script>
    window['__onGCastApiAvailable'] = (isAvailable) => {
      if (isAvailable) {
        cast.framework.CastContext.getInstance().setOptions({
          receiverApplicationId: '77C051C3',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
        
        const castButton = document.querySelector('google-cast-launcher');
        castButton.addEventListener('cast-connect', () => {
          console.log('Connected to Cast');
        });
        castButton.addEventListener('cast-disconnect', () => {
          console.log('Disconnected from Cast');
        });
    
        const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
        if (castSession) {
          console.log('Connected to Cast');
        }
      }
    };

  </script>
  <div class="mobile-landscape">
    <div style="position: relative; width: fit-content;">
      <h1 class="show-on-root" style="text-align: center;">Magic Mayhem</h1>
      <!-- Playing field -->
      <div id="game"></div>
      <div id="pause" class="hidden">Game Paused</div>
      <div id="game-over" class="hidden"></div>
      <div class="show-on-root" style="font-size: large;">
        <br>
        <!-- List of online games -->
        <div id="games"></div>
        <br>
        Game speed: <span id="game-speed">not set</span> <br><br>
        Summons: <br> <span id="summons">not set</span> <br><br>
        Controls: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Spacebar - pause <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"z x c" - summon blue L M & H <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"/ . ," - summon red L M & H <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"r" - restart <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"j" - create online game <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"+" - speed up <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"-" - slow down <br>
      </div>
      <br class="show-on-root">
      <div style="font-size: larger;" class="show-on-root">
        <p style="max-width: 700px; padding: 0; margin: 0;">
          At the Ministry of Magic, deep inside the Magic Vault, works Harold. Harold is a Magic Scribe apprentice and
          intern in the Magic Archives. He's tasked with transcribing every single duel between summoners throughout
          history. The deadline is 48 hours. With paper and pencil Harold presents: the epic battles of Magic Mayhem!
        </p>
      </div>
    </div>
    <div id="player-buttons" class="mobile middle left vertical">
      <button data-summon="HEAVY" class="summon-button">H</button>
      <button data-summon="MEDIUM" class="summon-button">M</button>
      <button data-summon="LIGHT" class="summon-button">L</button>
    </div>
    <div id="opponent-buttons" class="mobile middle right vertical">
      <button data-summon="HEAVY" class="summon-button">H</button>
      <button data-summon="MEDIUM" class="summon-button">M</button>
      <button data-summon="LIGHT" class="summon-button">L</button>
    </div>
  </div>
  <div id="warning-message" class="mobile center top">
    <h1>Warning!</h1>
    <p>This game is best played in landscape.</p>
    <p>Please turn your phone.</p>
    <p>Thank you!</p>
  </div>

  <script defer>
    if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
      document.querySelectorAll('.show-on-root').forEach(el => el.style.display = 'block');
    } else {
      document.body.style.overflowY = 'hidden';
    }
  </script>
</body>

</html>