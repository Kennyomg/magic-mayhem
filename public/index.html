<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Mayhem</title>
  <script src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1" defer></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script type="module" crossorigin>var Ie=Object.defineProperty;var me=(n,i,r)=>i in n?Ie(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r;var le=(n,i,r)=>(me(n,typeof i!="symbol"?i+"":i,r),r);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function i(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=i(t);fetch(t.href,a)}})();const b=40,R=20;let ce,ie,M,C,j="onorientationchange"in window&&"screen"in window,ve=j?"orientationchange":"resize";var ue;let de=((ue=screen==null?void 0:screen.orientation)==null?void 0:ue.type)||"landscape-primary";var Ee;(Ee=screen==null?void 0:screen.orientation)!=null&&Ee.angle;const w=document.getElementById("game"),U=document.getElementById("pause"),Te=document.getElementById("game-over");function se(){if(ce=(j?screen.height:window.innerHeight)-w.offsetTop,M=ce-50,C=25/18*M,ie=Math.max(75,Math.min(100,(j?screen.width:window.innerWidth)-C-20)),C>window.innerWidth&&(C=window.innerWidth-20,M=18/25*C),w.style.width=A(C),w.style.height=A(M),U.style.top=A(M/2+w.offsetTop),Te.style.top=A(M/2+w.offsetTop),w.children.length)for(const n of w.getElementsByClassName("cell"))n.style.width=A(C/b),n.style.height=A(M/R),n.style.fontSize=A(M/R)}se();window.addEventListener(ve,function(){j&&de!==screen.orientation.type&&(de=screen.orientation.type,screen.orientation.angle),se()},!1);j&&window.addEventListener("resize",()=>se(),!1);let N=3,T="",ne,l,_=!1,be=!1;const ee=class ee{constructor(i,r=0){this.text=i,this.ignoreFrontWidth=r}static async fromFile(i,r=0){try{return new this(ee.INLINE_SPRITES[i]||await fetch(i).then(t=>t.text()),r)}catch(t){throw console.error(t),new Error("Cannot load sprite from file")}}get lines(){return this.text.split(`
`).filter(Boolean)}get width(){return Math.max(...this.lines.map(i=>i.length))}get collisionWidth(){return this.width-this.ignoreFrontWidth}get height(){return this.lines.length}getCharAt(i,r,t){return i<0||i>this.width||r<0||r>this.height?(console.error(`Cannot get sprite char at x: ${i} and y: ${r}`),!1):t?this.lines[r][this.width-1-i]:this.lines[r][i]}};le(ee,"INLINE_SPRITES",{"./light.txt":";=,^<","./medium.txt":`()
||/
/\\`,"./heavy.txt":`      /_
<()> /_
/  \\/
 ||
/  \\`,"./wizard.txt":`  x
 / \\ * *
 | | /*
 / \\/
 | |`});let D=ee,x;const pe=10,oe=8,Y=10,S="blue",Q=4,fe=oe-1,$="red";let Z;const he=oe-1,V=R-1,re=Q,we=V-1;let J;const Le=V-1,B={EMPTY:"Â ",WALL:"#",PLAYER:"@",PORTAL:"O",SUMMON:"S"},m={LIGHT:{type:"LIGHT",x:1,y:V-1,sprite:void 0,speed:2,health:2,attack:1,team:"",mana_cost:1},MEDIUM:{type:"MEDIUM",x:1,y:V-1,sprite:void 0,speed:1,health:3,attack:2,team:"",mana_cost:2},HEAVY:{type:"HEAVY",x:1,y:V-1,sprite:void 0,speed:1,health:5,attack:1,team:"",mana_cost:3}},Pe=document.getElementById("summons");Pe.innerHTML="type, manacost, health, attack, speed<br/>";Pe.innerHTML+=Object.values(m).map(n=>`${n.type}, ${n.mana_cost}, ${n.health}, ${n.attack}, ${n.speed}`).join("<br/>");let v;window.location.hostname.includes("localhost")||window.location.protocol==="http:"?v=new WebSocket(`ws://${window.location.host}/ws`):v=new WebSocket(`wss://${window.location.host}/ws`);v.onopen=()=>{console.log("Connected to server"),T?v.send(JSON.stringify({type:"join_lobby",data:T})):ae().then(n=>{T=n,v.send(JSON.stringify({type:"join_lobby",data:T}))})};v.onclose=()=>{console.log("Disconnected from server")};(async()=>{console.log("magic-mayhem.js loaded");const n=document.getElementById("game-speed"),i=document.getElementById("game-over");n.textContent=N.toString();let r=ge(w),t=!1,a=!1,s=0,c=!1,d=[],y="",f="",g=Y,u=Y;try{x=await D.fromFile("./wizard.txt"),Z=b-Q-x.width,J=Z+x.width-1,m.LIGHT.sprite=await D.fromFile("./light.txt"),m.MEDIUM.sprite=await D.fromFile("./medium.txt"),m.HEAVY.sprite=await D.fromFile("./heavy.txt",3),console.log(m)}catch(p){console.error(p)}function F(p){w.innerHTML="",i.classList.add("hidden"),s=0,c=!1,d=[],g=Y,u=Y,y="",f="",r=ge(w),W(r,d),t=!1,a=!1,l&&confirm("Do you want to leave the game?")&&(_?(v.send(JSON.stringify({type:"delete_game",data:l})),_=!1):v.send(JSON.stringify({type:"leave_game",data:l})),l=null)}function z(p){t=!t,document.getElementById("pause").classList.toggle("hidden")}function X(p,I){function k(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!(t||a||be||l&&!_)&&(!y&&p==="player"&&(y=I.dataset.summon),!f&&p==="opponent")){if(l&&_)return;f=I.dataset.summon}}I.addEventListener("click",k),I.addEventListener("touchend",k)}let O=!1;function L(p){if(O)return O=!1;if(p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation(),a){F();return}z()}w.addEventListener("click",L),w.addEventListener("touchstart",()=>O=!1,{passive:!0}),w.addEventListener("touchmove",()=>O=!0,{passive:!0}),w.addEventListener("touchend",L),U.addEventListener("click",L),U.addEventListener("touchstart",()=>O=!1,{passive:!0}),U.addEventListener("touchmove",()=>O=!0,{passive:!0}),U.addEventListener("touchend",L),i.addEventListener("click",L),i.addEventListener("touchstart",()=>O=!1,{passive:!0}),i.addEventListener("touchmove",()=>O=!0,{passive:!0}),i.addEventListener("touchend",L);const P=document.getElementById("player-buttons");P.width=ie;for(const p of P.getElementsByClassName("summon-button"))X("player",p);const G=document.getElementById("opponent-buttons");G.width=ie;for(const p of G.getElementsByClassName("summon-button"))X("opponent",p);window.addEventListener("scroll",()=>{const p=window.scrollY>w.offsetTop+w.clientHeight-w.clientHeight/4*3;P.classList.toggle("hidden",p),G.classList.toggle("hidden",p)}),v.onmessage=({data:p})=>{const I=JSON.parse(p),k=document.getElementById("games");switch(I.type){case"broadcast":{if(console.log("Broadcast",I),l)return;if(Array.isArray(I.data)){k.innerHTML="";let e=1;for(const h of I.data){if(console.log("game",h),h.opponentPeerId===T){l=h;break}if(h.hostPeerId===T&&h.opponentPeerId){if(_&&l)break;_=!0,l=h;break}if(h.hostPeerId===T){const E=document.createElement("button");E.textContent=`Waiting for opponent ${e}`,k.appendChild(E),e++;continue}const o=document.createElement("button");o.textContent=`Join game ${e}`,o.onclick=async()=>{console.log("Joining game",e);const E=T||await ae();ne||(ne=new Peer(E,{host:window.location.hostname,port:window.location.port,path:"/peerjs/myapp"})),console.log("peer",E,ne),v.send(JSON.stringify({type:"join_game",data:{hostPeerId:h.hostPeerId,opponentPeerId:E}}))},k.appendChild(o),e++}}break}case"game_updated":{console.log("Game updated"),l.data=I.data,W(r,l.data.summons,l.data.playerMana,l.data.opponentMana);break}case"game_deleted":{l=null;break}case"spawn":{f=I.data.summon;break}default:{console.log("Unknown message",I);break}}},window.addEventListener("keydown",async p=>{switch(p.key){case"j":T||(T=await ae()),v.send(JSON.stringify({type:"create_game",data:T}));break;case" ":if(p.preventDefault(),a)break;z();break;case"r":case"R":F();break;case"z":if(t)break;y||(y="LIGHT");break;case"x":if(t)break;y||(y="MEDIUM");break;case"c":if(t)break;y||(y="HEAVY");break;case"/":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"LIGHT",hostPeerId:l.hostPeerId}}));break}f||(f="LIGHT");break;case".":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"MEDIUM",hostPeerId:l.hostPeerId}}));break}f||(f="MEDIUM");break;case",":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"HEAVY",hostPeerId:l.hostPeerId}}));break}f||(f="HEAVY");break;case"+":N<100&&(N+=1,n.textContent=N.toString(),te());break;case"-":N>1&&(N-=1,n.textContent=N.toString(),te());break}});let q=null;function te(){clearInterval(q),q=setInterval(()=>{var p,I,k;if(!(l&&!_)){if(l&&(l.hostPeerId===T&&v.send(JSON.stringify({type:"update_game",data:{...l,data:{summons:d,playerMana:g,opponentMana:u}}})),l.opponentPeerId===T&&(d=(p=l.data)!=null&&p.summons?l.data.summons:[],g=((I=l.data)==null?void 0:I.playerMana)>=0?l.data.playerMana:Y,u=((k=l.data)==null?void 0:k.playerMana)>=0?l.data.opponentMana:Y,d.length))){W(r,d,g,u);return}if(!t){(!l||_)&&(y&&!d.some(e=>{var h,o;return e.team==="player"&&K(re,we,(o=(h=m[y])==null?void 0:h.sprite)==null?void 0:o.collisionWidth,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(g>=m[y].mana_cost&&g>=g-m[y].mana_cost&&(g-=m[y].mana_cost,d.push(ye("player",y))),y=""),f&&!d.some(e=>{var h,o;return e.team==="opponent"&&K(J-((o=(h=m[f])==null?void 0:h.sprite)==null?void 0:o.collisionWidth),Le,J,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(u>=m[f].mana_cost&&u>=u-m[f].mana_cost&&(u-=m[f].mana_cost,d.push(ye("opponent",f))),f="")),W(r,d,g,u);for(const e of d){const h=e.x+e.speed*e.direction;if(!d.some(o=>o!==e&&K(h,e.y,e.sprite.collisionWidth,e.sprite.height,o.x,o.y,o.sprite.collisionWidth,o.sprite.height)))h>0&&h<b-e.sprite.collisionWidth?e.x=h:(e.x=h<=0?1:b-e.sprite.collisionWidth-1,e.direction*=-1),c=!0;else{const o=d.find(E=>E!==e&&K(h,e.y,e.sprite.collisionWidth,e.sprite.height,E.direction>0?E.x:E.x+E.sprite.ignoreFrontWidth,E.y,E.sprite.collisionWidth,E.sprite.height));if(e&&o&&(e!=null&&e.type)&&(o!=null&&o.type)&&(e==null?void 0:e.type)==="LIGHT"&&(o==null?void 0:o.type)==="HEAVY"&&((e==null?void 0:e.team)===o.team||(e==null?void 0:e.direction)!==(o==null?void 0:o.direction))||(e==null?void 0:e.type)==="HEAVY"&&(o==null?void 0:o.type)==="LIGHT"&&((e==null?void 0:e.team)===(o==null?void 0:o.team)||(e==null?void 0:e.direction)!==(o==null?void 0:o.direction))){e.x=h,c=!0;continue}e&&o&&e.attack>0&&e.team!==o.team&&e.health>0&&o.health>0&&(o.health-=e.attack,o.health<=0&&(d=d.filter(E=>E!==o)),c=!0)}}c?s=0:s++,s>10&&!(g||u)&&(t=!0,a=!0,i.innerHTML=`Draw!!\r
Press R or Tap here.`,i.classList.remove("hidden"),W(r,d,g,u)),c=!1,!d.some(e=>e.team==="player")&&!g&&(t=!0,a=!0,i.innerHTML=`<span style="color:${$};">${$.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,i.classList.remove("hidden"),W(r,d,g,u)),!d.some(e=>e.team==="opponent")&&!u&&(t=!0,a=!0,i.innerHTML=`<span style="color:${S};">${S.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,i.classList.remove("hidden"),W(r,d,g,u))}}},1e3/N)}te()})();function A(n){return`${n}px`}async function ae(){return await fetch(`${window.location.protocol}//${window.location.host}/peerjs/myapp/peerjs/id`).then(n=>n.body.getReader().read()).then(({value:n,done:i})=>new TextDecoder().decode(n))}function ye(n,i){if(!(n==="player"||n==="opponent"))throw new Error("Invalid team");return{...m[i],x:n==="player"?re:J-m[i].sprite.width+1,direction:n==="player"?1:-1,color:n==="player"?S:$,team:n}}function ge(n){return new Array(R).fill(null).map((i,r)=>(r>0&&n.appendChild(document.createElement("br")),new Array(b).fill(null).map(()=>{const t=document.createElement("span");return t.classList.add("cell"),t.style.width=A(C/b),t.style.height=A(M/R),t.style.fontSize=A(M/R),t.textContent=B.EMPTY,n.appendChild(t),t})))}function H(n,i,r,t,a,s){return n>=r&&n<r+a&&i<=t&&i>t-s}function K(n,i,r,t,a,s,c,d){return H(n,i,a,s,c,d)||H(n+r-1,i,a,s,c,d)||H(n,i-t,a,s,c,d)||H(n+r-1,i-t,a,s,c,d)}function W(n,i,r,t){i.sort((a,s)=>a.type===s.type?0:a.type==="HEAVY"&&s.type!=="HEAVY"||a.type==="MEDIUM"&&s.type==="LIGHT"?-1:(a.type==="LIGHT"&&s.type!=="LIGHT",1));for(let a=0;a<R;a++)for(let s=0;s<b;s++){const c=n[a][s],d=s===0||s===b-1||a===0||a===R-1,y=s>0&&(s<pe||s>b-1-pe)&&s<b-1&&a===oe,f=H(s,a,Q,fe,x.width,x.height),g=H(s,a,Z,he,x.width,x.height),u=s===re&&a===we,F=s===J&&a===Le,z=r&&(s===1||s<=r)&&a===1,X=t&&(s===b-2||s>=b-1-t)&&a===1,O=i.some(L=>H(s,a,L.x,L.y,L.sprite.width,L.sprite.height));switch(!0){case(d||y):c.classList.add("wall"),c.textContent!==B.WALL&&(c.textContent=B.WALL);break;case z:c.textContent="*",c.style.color=S;break;case X:c.textContent="*",c.style.color=$;break;case(f||g):{let L;(L=x.getCharAt(s-(f?Q:Z),a-(f?fe:he)+x.height-1,g))&&c.textContent!==L&&(c.textContent=L,c.style.color=f?S:$,g&&c.classList.add("reversed"));break}case O:{i.filter(P=>H(s,a,P.x,P.y,P.sprite.width,P.sprite.height)).forEach(P=>{const G=P.direction===-1,q=P.sprite.getCharAt(s-P.x,a-P.y+P.sprite.height-1,G);c.classList.toggle("reversed",G),c.textContent=q,c.style.color=P.color});break}case(u||F):c.textContent!==B.PORTAL&&(c.textContent=B.PORTAL,c.style.color=u?S:$);break;default:c.textContent!==B.EMPTY&&(c.textContent=B.EMPTY);break}}}
</script>
  <style rel="stylesheet" crossorigin>body{font-family:Courier New,Courier,monospace;display:flex;justify-content:center}br{display:block;height:0}#game{width:fit-content;margin:0 auto}.cell{display:block;float:left;font-size:25px;line-height:1;font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000}#game br{display:block;height:0;line-height:0;content:"";margin:0}.blue{color:#00f}.red{color:red}#pause{position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;-webkit-user-select:none;user-select:none}#game-over{text-align:center;position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;white-space:pre;-webkit-user-select:none;user-select:none}.summon-button{display:inline-block;aspect-ratio:1/1;font-size:min(100px,calc((100svh / 3) - 20px));font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000;border:2px solid white;border-radius:50%;cursor:pointer;max-width:100%;text-align:center;line-height:1}#player-buttons,#opponent-buttons{touch-action:none;display:flex;flex-direction:column;gap:10px;width:min(100px,calc((100svh / 3) - 20px))}#player-buttons>.summon-button:hover,#player-buttons>.summon-button:active{color:#00f;border-color:#00f}#opponent-buttons>.summon-button:hover,#opponent-buttons>.summon-button:active{color:red;border-color:red}.hidden{display:none!important}.reversed{transform:rotateY(180deg)}.show-on-root,.mobile{display:none}.top{position:fixed;top:0}.middle{position:fixed;top:50%;transform:translateY(-50%)}.left{position:fixed;left:10px}.right{position:fixed;right:10px}.bottom{position:fixed;bottom:0}.vertical{display:flex;flex-direction:column}#warning-message{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px}@media screen and (max-width: 425px){#game,.mobile-landscape{display:none}#warning-message{display:block}}@media screen and (min-width: 425px) and (max-width: 868px) and (orientation: landscape){.mobile{display:block}.vertical{display:flex}}@media screen and (min-width: 868px){.mobile{display:none}}
</style>
</head>

<body style="background-color: black; color: white;">
  <google-cast-launcher></google-cast-launcher>
  <script>
    window['__onGCastApiAvailable'] = (isAvailable) => {
      if (isAvailable) {
        cast.framework.CastContext.getInstance().setOptions({
          receiverApplicationId: '77C051C3',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
        
        const castButton = document.querySelector('google-cast-launcher');
        castButton.addEventListener('cast-connect', () => {
          console.log('Connected to Cast');
          // Send html element with id 'game' to cast device
          cast.framework.CastContext.getInstance().getCurrentSession().sendMedia({
            media: {
              contentId: 'game',
              contentType: 'text/html',
              streamType: chrome.cast.StreamType.BUFFERED
            }
          });
        });
        castButton.addEventListener('cast-disconnect', () => {
          console.log('Disconnected from Cast');
        });
    
        const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
        if (castSession) {
          console.log('Connected to Cast');
        }
      }
    };

  </script>
  <div class="mobile-landscape">
    <div style="position: relative; width: fit-content;">
      <h1 class="show-on-root" style="text-align: center;">Magic Mayhem</h1>
      <!-- Playing field -->
      <div id="game"></div>
      <div id="pause" class="hidden">Game Paused</div>
      <div id="game-over" class="hidden"></div>
      <div class="show-on-root" style="font-size: large;">
        <br>
        <!-- List of online games -->
        <div id="games"></div>
        <br>
        Game speed: <span id="game-speed">not set</span> <br><br>
        Summons: <br> <span id="summons">not set</span> <br><br>
        Controls: <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Spacebar - pause <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"z x c" - summon blue L M & H <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"/ . ," - summon red L M & H <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"r" - restart <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"j" - create online game <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"+" - speed up <br>
        &nbsp;&nbsp;&nbsp;&nbsp;"-" - slow down <br>
      </div>
      <br class="show-on-root">
      <div style="font-size: larger;" class="show-on-root">
        <p style="max-width: 700px; padding: 0; margin: 0;">
          At the Ministry of Magic, deep inside the Magic Vault, works Harold. Harold is a Magic Scribe apprentice and
          intern in the Magic Archives. He's tasked with transcribing every single duel between summoners throughout
          history. The deadline is 48 hours. With paper and pencil Harold presents: the epic battles of Magic Mayhem!
        </p>
      </div>
    </div>
    <div id="player-buttons" class="mobile middle left vertical">
      <button data-summon="HEAVY" class="summon-button">H</button>
      <button data-summon="MEDIUM" class="summon-button">M</button>
      <button data-summon="LIGHT" class="summon-button">L</button>
    </div>
    <div id="opponent-buttons" class="mobile middle right vertical">
      <button data-summon="HEAVY" class="summon-button">H</button>
      <button data-summon="MEDIUM" class="summon-button">M</button>
      <button data-summon="LIGHT" class="summon-button">L</button>
    </div>
  </div>
  <div id="warning-message" class="mobile center top">
    <h1>Warning!</h1>
    <p>This game is best played in landscape.</p>
    <p>Please turn your phone.</p>
    <p>Thank you!</p>
  </div>

  <script defer>
    if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
      document.querySelectorAll('.show-on-root').forEach(el => el.style.display = 'block');
    } else {
      document.body.style.overflowY = 'hidden';
    }
  </script>
</body>

</html>