<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="//www.gstatic.com/cast/sdk/libs/devtools/debug_layer/caf_receiver_logger.js"></script>
  <script type="module" crossorigin>var Ie=Object.defineProperty;var me=(n,i,r)=>i in n?Ie(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r;var ce=(n,i,r)=>(me(n,typeof i!="symbol"?i+"":i,r),r);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function i(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=i(t);fetch(t.href,a)}})();const b=40,W=20;let de,ae,A,H,j="onorientationchange"in window&&"screen"in window,ve=j?"orientationchange":"resize";var Ee;let pe=((Ee=screen==null?void 0:screen.orientation)==null?void 0:Ee.type)||"landscape-primary";var we;(we=screen==null?void 0:screen.orientation)!=null&&we.angle;const L=document.getElementById("game"),U=document.getElementById("pause"),Te=document.getElementById("game-over");function oe(){if(de=(j?screen.height:window.innerHeight)-L.offsetTop,A=de-50,H=25/18*A,ae=Math.max(75,Math.min(100,(j?screen.width:window.innerWidth)-H-20)),H>window.innerWidth&&(H=window.innerWidth-20,A=18/25*H),L.style.width=k(H),L.style.height=k(A),U.style.top=k(A/2+L.offsetTop),Te.style.top=k(A/2+L.offsetTop),L.children.length)for(const n of L.getElementsByClassName("cell"))n.style.width=k(H/b),n.style.height=k(A/W),n.style.fontSize=k(A/W)}oe();window.addEventListener(ve,function(){j&&pe!==screen.orientation.type&&(pe=screen.orientation.type,screen.orientation.angle),oe()},!1);j&&window.addEventListener("resize",()=>oe(),!1);let C=3,T="",ne,l,_=!1,be=!1;const ee=class ee{constructor(i,r=0){this.text=i,this.ignoreFrontWidth=r}static async fromFile(i,r=0){try{return new this(ee.INLINE_SPRITES[i]||await fetch(i).then(t=>t.text()),r)}catch(t){throw console.error(t),new Error("Cannot load sprite from file")}}get lines(){return this.text.split(`
`).filter(Boolean)}get width(){return Math.max(...this.lines.map(i=>i.length))}get collisionWidth(){return this.width-this.ignoreFrontWidth}get height(){return this.lines.length}getCharAt(i,r,t){return i<0||i>this.width||r<0||r>this.height?(console.error(`Cannot get sprite char at x: ${i} and y: ${r}`),!1):t?this.lines[r][this.width-1-i]:this.lines[r][i]}};ce(ee,"INLINE_SPRITES",{"./light.txt":";=,^<","./medium.txt":`()
||/
/\\`,"./heavy.txt":`      /_
<()> /_
/  \\/
 ||
/  \\`,"./wizard.txt":`  x
 / \\ * *
 | | /*
 / \\/
 | |`});let D=ee,x;const fe=10,re=8,Y=10,S="blue",Q=4,he=re-1,$="red";let Z;const ye=re-1,V=W-1,le=Q,Le=V-1;let J;const Pe=V-1,G={EMPTY:"Â ",WALL:"#",PLAYER:"@",PORTAL:"O",SUMMON:"S"},m={LIGHT:{type:"LIGHT",x:1,y:V-1,sprite:void 0,speed:2,health:2,attack:1,team:"",mana_cost:1},MEDIUM:{type:"MEDIUM",x:1,y:V-1,sprite:void 0,speed:1,health:3,attack:2,team:"",mana_cost:2},HEAVY:{type:"HEAVY",x:1,y:V-1,sprite:void 0,speed:1,health:5,attack:1,team:"",mana_cost:3}},ie=document.getElementById("summons");ie&&(ie.innerHTML="type, manacost, health, attack, speed<br/>",ie.innerHTML+=Object.values(m).map(n=>`${n.type}, ${n.mana_cost}, ${n.health}, ${n.attack}, ${n.speed}`).join("<br/>"));let v;window.location.hostname.includes("localhost")||window.location.protocol==="http:"?v=new WebSocket(`ws://${window.location.host}/ws`):v=new WebSocket(`wss://${window.location.host}/ws`);v.onopen=()=>{console.log("Connected to server"),T?v.send(JSON.stringify({type:"join_lobby",data:T})):se().then(n=>{T=n,v.send(JSON.stringify({type:"join_lobby",data:T}))})};v.onclose=()=>{console.log("Disconnected from server")};(async()=>{console.log("magic-mayhem.js loaded");const n=document.getElementById("game-speed"),i=document.getElementById("game-over");n&&(n.textContent=C.toString());let r=ue(L),t=!1,a=!1,s=0,c=!1,d=[],y="",f="",g=Y,u=Y;try{x=await D.fromFile("./wizard.txt"),Z=b-Q-x.width,J=Z+x.width-1,m.LIGHT.sprite=await D.fromFile("./light.txt"),m.MEDIUM.sprite=await D.fromFile("./medium.txt"),m.HEAVY.sprite=await D.fromFile("./heavy.txt",3),console.log(m)}catch(p){console.error(p)}function F(p){L.innerHTML="",i.classList.add("hidden"),s=0,c=!1,d=[],g=Y,u=Y,y="",f="",r=ue(L),B(r,d),t=!1,a=!1,l&&confirm("Do you want to leave the game?")&&(_?(v.send(JSON.stringify({type:"delete_game",data:l})),_=!1):v.send(JSON.stringify({type:"leave_game",data:l})),l=null)}function z(p){t=!t,document.getElementById("pause").classList.toggle("hidden")}function X(p,I){function M(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!(t||a||be||l&&!_)&&(!y&&p==="player"&&(y=I.dataset.summon),!f&&p==="opponent")){if(l&&_)return;f=I.dataset.summon}}I.addEventListener("click",M),I.addEventListener("touchend",M)}let O=!1;function P(p){if(O)return O=!1;if(p.preventDefault(),p.stopPropagation(),p.stopImmediatePropagation(),a){F();return}z()}L.addEventListener("click",P),L.addEventListener("touchstart",()=>O=!1,{passive:!0}),L.addEventListener("touchmove",()=>O=!0,{passive:!0}),L.addEventListener("touchend",P),U.addEventListener("click",P),U.addEventListener("touchstart",()=>O=!1,{passive:!0}),U.addEventListener("touchmove",()=>O=!0,{passive:!0}),U.addEventListener("touchend",P),i.addEventListener("click",P),i.addEventListener("touchstart",()=>O=!1,{passive:!0}),i.addEventListener("touchmove",()=>O=!0,{passive:!0}),i.addEventListener("touchend",P);const E=document.getElementById("player-buttons");if(E){E.width=ae;for(const p of E.getElementsByClassName("summon-button"))X("player",p)}const N=document.getElementById("opponent-buttons");if(N){N.width=ae;for(const p of N.getElementsByClassName("summon-button"))X("opponent",p)}window.addEventListener("scroll",()=>{const p=window.scrollY>L.offsetTop+L.clientHeight-L.clientHeight/4*3;E&&E.classList.toggle("hidden",p),N&&N.classList.toggle("hidden",p),t=!p}),v.onmessage=({data:p})=>{const I=JSON.parse(p),M=document.getElementById("games");switch(I.type){case"broadcast":{if(console.log("Broadcast",I),l||!M)return;if(Array.isArray(I.data)){M.innerHTML="";let e=1;for(const h of I.data){if(console.log("game",h),h.opponentPeerId===T){l=h;break}if(h.hostPeerId===T&&h.opponentPeerId){if(_&&l)break;_=!0,l=h;break}if(h.hostPeerId===T){const w=document.createElement("button");w.textContent=`Waiting for opponent ${e}`,M.appendChild(w),e++;continue}const o=document.createElement("button");o.textContent=`Join game ${e}`,o.onclick=async()=>{console.log("Joining game",e);const w=T||await se();ne||(ne=new Peer(w,{host:window.location.hostname,port:window.location.port,path:"/peerjs/myapp"})),console.log("peer",w,ne),v.send(JSON.stringify({type:"join_game",data:{hostPeerId:h.hostPeerId,opponentPeerId:w}}))},M.appendChild(o),e++}}break}case"game_updated":{console.log("Game updated"),l.data=I.data,B(r,l.data.summons,l.data.playerMana,l.data.opponentMana);break}case"game_deleted":{l=null;break}case"spawn":{f=I.data.summon;break}default:{console.log("Unknown message",I);break}}},window.addEventListener("keydown",async p=>{switch(p.key){case"j":T||(T=await se()),v.send(JSON.stringify({type:"create_game",data:T}));break;case" ":if(p.preventDefault(),a)break;z();break;case"r":case"R":F();break;case"z":if(t)break;y||(y="LIGHT");break;case"x":if(t)break;y||(y="MEDIUM");break;case"c":if(t)break;y||(y="HEAVY");break;case"/":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"LIGHT",hostPeerId:l.hostPeerId}}));break}f||(f="LIGHT");break;case".":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"MEDIUM",hostPeerId:l.hostPeerId}}));break}f||(f="MEDIUM");break;case",":if(t)break;if(l){_||v.send(JSON.stringify({type:"spawn",data:{summon:"HEAVY",hostPeerId:l.hostPeerId}}));break}f||(f="HEAVY");break;case"+":C<100&&(C+=1,n.textContent=C.toString(),te());break;case"-":C>1&&(C-=1,n.textContent=C.toString(),te());break}});let q=null;function te(){clearInterval(q),q=setInterval(()=>{var p,I,M;if(!(l&&!_)){if(l&&(l.hostPeerId===T&&v.send(JSON.stringify({type:"update_game",data:{...l,data:{summons:d,playerMana:g,opponentMana:u}}})),l.opponentPeerId===T&&(d=(p=l.data)!=null&&p.summons?l.data.summons:[],g=((I=l.data)==null?void 0:I.playerMana)>=0?l.data.playerMana:Y,u=((M=l.data)==null?void 0:M.playerMana)>=0?l.data.opponentMana:Y,d.length))){B(r,d,g,u);return}if(!t){(!l||_)&&(y&&!d.some(e=>{var h,o;return e.team==="player"&&K(le,Le,(o=(h=m[y])==null?void 0:h.sprite)==null?void 0:o.collisionWidth,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(g>=m[y].mana_cost&&g>=g-m[y].mana_cost&&(g-=m[y].mana_cost,d.push(ge("player",y))),y=""),f&&!d.some(e=>{var h,o;return e.team==="opponent"&&K(J-((o=(h=m[f])==null?void 0:h.sprite)==null?void 0:o.collisionWidth),Pe,J,1,e.x,e.y,e.sprite.width,e.sprite.height)})&&(u>=m[f].mana_cost&&u>=u-m[f].mana_cost&&(u-=m[f].mana_cost,d.push(ge("opponent",f))),f="")),B(r,d,g,u);for(const e of d){const h=e.x+e.speed*e.direction;if(!d.some(o=>o!==e&&K(h,e.y,e.sprite.collisionWidth,e.sprite.height,o.x,o.y,o.sprite.collisionWidth,o.sprite.height)))h>0&&h<b-e.sprite.collisionWidth?e.x=h:(e.x=h<=0?1:b-e.sprite.collisionWidth-1,e.direction*=-1),c=!0;else{const o=d.find(w=>w!==e&&K(h,e.y,e.sprite.collisionWidth,e.sprite.height,w.direction>0?w.x:w.x+w.sprite.ignoreFrontWidth,w.y,w.sprite.collisionWidth,w.sprite.height));if(e&&o&&(e!=null&&e.type)&&(o!=null&&o.type)&&(e==null?void 0:e.type)==="LIGHT"&&(o==null?void 0:o.type)==="HEAVY"&&((e==null?void 0:e.team)===o.team||(e==null?void 0:e.direction)!==(o==null?void 0:o.direction))||(e==null?void 0:e.type)==="HEAVY"&&(o==null?void 0:o.type)==="LIGHT"&&((e==null?void 0:e.team)===(o==null?void 0:o.team)||(e==null?void 0:e.direction)!==(o==null?void 0:o.direction))){e.x=h,c=!0;continue}e&&o&&e.attack>0&&e.team!==o.team&&e.health>0&&o.health>0&&(o.health-=e.attack,o.health<=0&&(d=d.filter(w=>w!==o)),c=!0)}}c?s=0:s++,s>10&&!(g||u)&&(t=!0,a=!0,i.innerHTML=`Draw!!\r
Press R or Tap here.`,i.classList.remove("hidden"),B(r,d,g,u)),c=!1,!d.some(e=>e.team==="player")&&!g&&(t=!0,a=!0,i.innerHTML=`<span style="color:${$};">${$.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,i.classList.remove("hidden"),B(r,d,g,u)),!d.some(e=>e.team==="opponent")&&!u&&(t=!0,a=!0,i.innerHTML=`<span style="color:${S};">${S.toUpperCase()}</span> Won!!\r
Press R or Tap here.`,i.classList.remove("hidden"),B(r,d,g,u))}}},1e3/C)}te()})();function k(n){return`${n}px`}async function se(){return await fetch(`${window.location.protocol}//${window.location.host}/peerjs/myapp/peerjs/id`).then(n=>n.body.getReader().read()).then(({value:n,done:i})=>new TextDecoder().decode(n))}function ge(n,i){if(!(n==="player"||n==="opponent"))throw new Error("Invalid team");return{...m[i],x:n==="player"?le:J-m[i].sprite.width+1,direction:n==="player"?1:-1,color:n==="player"?S:$,team:n}}function ue(n){return new Array(W).fill(null).map((i,r)=>(r>0&&n.appendChild(document.createElement("br")),new Array(b).fill(null).map(()=>{const t=document.createElement("span");return t.classList.add("cell"),t.style.width=k(H/b),t.style.height=k(A/W),t.style.fontSize=k(A/W),t.textContent=G.EMPTY,n.appendChild(t),t})))}function R(n,i,r,t,a,s){return n>=r&&n<r+a&&i<=t&&i>t-s}function K(n,i,r,t,a,s,c,d){return R(n,i,a,s,c,d)||R(n+r-1,i,a,s,c,d)||R(n,i-t,a,s,c,d)||R(n+r-1,i-t,a,s,c,d)}function B(n,i,r,t){i.sort((a,s)=>a.type===s.type?0:a.type==="HEAVY"&&s.type!=="HEAVY"||a.type==="MEDIUM"&&s.type==="LIGHT"?-1:(a.type==="LIGHT"&&s.type!=="LIGHT",1));for(let a=0;a<W;a++)for(let s=0;s<b;s++){const c=n[a][s],d=s===0||s===b-1||a===0||a===W-1,y=s>0&&(s<fe||s>b-1-fe)&&s<b-1&&a===re,f=R(s,a,Q,he,x.width,x.height),g=R(s,a,Z,ye,x.width,x.height),u=s===le&&a===Le,F=s===J&&a===Pe,z=r&&(s===1||s<=r)&&a===1,X=t&&(s===b-2||s>=b-1-t)&&a===1,O=i.some(P=>R(s,a,P.x,P.y,P.sprite.width,P.sprite.height));switch(!0){case(d||y):c.classList.add("wall"),c.textContent!==G.WALL&&(c.textContent=G.WALL);break;case z:c.textContent="*",c.style.color=S;break;case X:c.textContent="*",c.style.color=$;break;case(f||g):{let P;(P=x.getCharAt(s-(f?Q:Z),a-(f?he:ye)+x.height-1,g))&&c.textContent!==P&&(c.textContent=P,c.style.color=f?S:$,g&&c.classList.add("reversed"));break}case O:{i.filter(E=>R(s,a,E.x,E.y,E.sprite.width,E.sprite.height)).forEach(E=>{const N=E.direction===-1,q=E.sprite.getCharAt(s-E.x,a-E.y+E.sprite.height-1,N);c.classList.toggle("reversed",N),c.textContent=q,c.style.color=E.color});break}case(u||F):c.textContent!==G.PORTAL&&(c.textContent=G.PORTAL,c.style.color=u?S:$);break;default:c.textContent!==G.EMPTY&&(c.textContent=G.EMPTY);break}}}
</script>
  <style rel="stylesheet" crossorigin>body{font-family:Courier New,Courier,monospace;display:flex;justify-content:center}br{display:block;height:0}#game{width:fit-content;margin:0 auto}.cell{display:block;float:left;font-size:25px;line-height:1;font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000}#game br{display:block;height:0;line-height:0;content:"";margin:0}.blue{color:#00f}.red{color:red}#pause{position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;-webkit-user-select:none;user-select:none}#game-over{text-align:center;position:absolute;top:300px;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px;white-space:pre;-webkit-user-select:none;user-select:none}.summon-button{display:inline-block;aspect-ratio:1/1;font-size:min(100px,calc((100svh / 3) - 20px));font-family:Courier New,Courier,monospace;font-weight:700;color:#fff;background-color:#000;border:2px solid white;border-radius:50%;cursor:pointer;max-width:100%;text-align:center;line-height:1}#player-buttons,#opponent-buttons{touch-action:none;display:flex;flex-direction:column;gap:10px;width:min(100px,calc((100svh / 3) - 20px))}#player-buttons>.summon-button:hover,#player-buttons>.summon-button:active{color:#00f;border-color:#00f}#opponent-buttons>.summon-button:hover,#opponent-buttons>.summon-button:active{color:red;border-color:red}.hidden{display:none!important}.reversed{transform:rotateY(180deg)}.show-on-root,.mobile{display:none}.top{position:fixed;top:0}.middle{position:fixed;top:50%;transform:translateY(-50%)}.left{position:fixed;left:10px}.right{position:fixed;right:10px}.bottom{position:fixed;bottom:0}.vertical{display:flex;flex-direction:column}#warning-message{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:30px}@media screen and (max-width: 425px){#game,.mobile-landscape{display:none}#warning-message{display:block}}@media screen and (min-width: 425px) and (max-width: 868px) and (orientation: landscape){.mobile{display:block}.vertical{display:flex}}@media screen and (min-width: 868px){.mobile{display:none}}
</style>
</head>

<body style="background-color: black; color: white;">
    <div class="mobile-landscape">
        <h1 style="text-align: center;">Magic Mayhem Spectator</h1>
        <div style="position: relative; width: fit-content;">
            <div id="game"></div>
            <div id="pause" class="hidden">Game Paused</div>
            <div id="game-over" class="hidden"></div>
        </div>
    </div>
    <script>
        const receiverApplicationId = "FE311E58";
    </script>
</body>

</html>